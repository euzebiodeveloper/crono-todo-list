name: Verificar Atividades Vencidas

on:
  schedule:
    # Executa a cada 10 minutos
    - cron: '*/10 * * * *'
  # Permite execução manual via interface do GitHub
  workflow_dispatch:

jobs:
  check-overdue:
    runs-on: ubuntu-latest
    
    steps:
      - name: Verificar atividades vencidas
        run: |
          echo "Iniciando verificação de atividades vencidas..."
          echo "[DEBUG] URL Base: ${{ secrets.API_BASE_URL }}"
          echo "[DEBUG] CRON_SECRET configurado: ${{ secrets.CRON_SECRET != '' && 'SIM' || 'NÃO' }}"
          echo "[DEBUG] URL Completa: ${{ secrets.API_BASE_URL }}/notifications/check-overdue"
          
          # Faz requisição POST para o backend e captura resposta
          response=$(curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -w "\n%{http_code}" \
            -s \
            ${{ secrets.API_BASE_URL }}/notifications/check-overdue)
          
          # Extrai o código HTTP (última linha)
          http_code=$(echo "$response" | tail -n1)
          # Extrai o corpo da resposta (tudo exceto última linha)
          body=$(echo "$response" | sed '$d')
          
          echo "[DEBUG] Status HTTP: $http_code"
          echo "[DEBUG] Resposta do servidor: $body"
          
          # Verifica se foi bem-sucedido
          if [ "$http_code" -eq 200 ]; then
            echo "✓ Verificação concluída com sucesso!"
            exit 0
          else
            echo "✗ Erro na verificação (HTTP $http_code)"
            exit 1
          fi

      - name: Notificar falha
        if: failure()
        run: |
          echo "A verificação de atividades vencidas falhou."
          echo "Verifique os logs acima para mais detalhes."
